# 1. Setup & Configuration (all logic moved to common.smk)
include: "rules/common.smk"

localrules:
    merge_stats_libraries_into_groups,

# 2. Domain Logic (in dependency order)
include: "rules/qc.smk"          # Fastp, MultiQC
include: "rules/align.smk"       # BWA, Bowtie2, Chromap
include: "rules/pairtools.smk"    # Pairtools
include: "rules/hicpro_style.smk" # HiC-Pro style processing
include: "rules/cooltools.smk"    # Cooler generation
include: "rules/downstream.smk"   # Downstream analysis
include: "rules/report.smk"       # Stats compilation

# 3. Output Definitions
# Note: min_resolution is defined in common.smk

# Setting up scaling from pairs outputs if required
library_scaling_pairs = []
if "scaling_pairs" in config and config["scaling_pairs"].get("do", True):
    library_scaling_pairs = expand(
        f"{pairs_library_folder}/{{library}}.{assembly}.nodups.scaling.tsv",
        library=SAMPLE_FASTQS.keys(),
    )
    if not config["scaling_pairs"].get("max_distance", False):
        chromsizes = pd.read_table(
            chromsizes_path, header=None, names=["chrom", "size"]
        )
        config["scaling_pairs"]["max_distance"] = chromsizes["size"].max()

# Setting up the library cooler outputs
library_coolers = expand(
    f"{coolers_library_folder}/{{library}}.{assembly}.{{filter_name}}.{min_resolution}.mcool",
    library=SAMPLE_FASTQS.keys(),
    filter_name=list(config["bin"]["filters"].keys()),
)

library_downstream_stat = expand(
    f"{downstream_dist_folder}/{{library}}.{{filter_name}}.{min_resolution}_loglog_fits.csv",
    library=SAMPLE_FASTQS.keys(),
    filter_name=list(config["bin"]["filters"].keys()),
)

library_mustache_loops = expand(
    f"{downstream_loops_folder}/{{library}}.{{filter_name}}.{{resolution}}_loops.tsv",
    library=SAMPLE_FASTQS.keys(),
    filter_name=list(config["bin"]["filters"].keys()),
    resolution=config["bin"]["resolution_for_mustache"],
)

library_hic = []
if config["bin"].get("make_hic", False):
    library_hic += expand(
        f"{coolers_library_folder}/{{library}}.{assembly}.{{filter_name}}.{min_resolution}.hic",
        library=SAMPLE_FASTQS.keys(),
        filter_name=list(config["bin"]["filters"].keys()),
    )

# Setting up the library group cooler and group stats outputs
library_group_coolers = []
library_group_hic = []
library_group_stats = []
if "library_groups" in config["input"] and len(config["input"]["library_groups"]) > 0:
    library_group_coolers = expand(
        f"{coolers_library_group_folder}/{{library_group}}.{assembly}.{{filter_name}}.{min_resolution}.mcool",
        library_group=config["input"]["library_groups"].keys(),
        filter_name=list(config["bin"]["filters"].keys()),
    )
    if config["bin"].get("make_hic", False):
        library_group_hic = expand(
            f"{coolers_library_group_folder}/{{library_group}}.{assembly}.{{filter_name}}.{min_resolution}.hic",
            library_group=config["input"]["library_groups"].keys(),
            filter_name=list(config["bin"]["filters"].keys()),
        )
    library_group_stats = expand(
        f"{stats_library_group_folder}/{{library_group}}.{assembly}.stats",
        library_group=config["input"]["library_groups"].keys(),
    )

assemble_mapstats = []
assemble_pairstats = []
for sample in SAMPLE_FASTQS.keys():
    assemble_mapstats.append(
        f"{mapped_parsed_sorted_chunks_folder}/{sample}.assemble.mapstat"
    )
    assemble_pairstats.append(
        f"{mapped_parsed_sorted_chunks_folder}/{sample}.assemble.pairstat"
    )

multiqc = [f"{multiqc_folder}/multiqc_report.html"]
combined_dedup_stats = f"{pairs_library_folder}/combined_dedup_stats_summary.tsv"
combined_mapstats = f"{pairs_library_folder}/combined_mapstats_summary.tsv"
combined_pairstats = f"{pairs_library_folder}/combined_pairstats_summary.tsv"
combined_RSstats = f"{pairs_library_folder}/combined_RSstats_summary.tsv"
combined_hicproPairstats = f"{pairs_library_folder}/combined_hicpro_pairstats_summary.tsv"
combined_stats = [combined_dedup_stats, combined_mapstats, combined_pairstats, combined_RSstats, combined_hicproPairstats]

allvalidPair = []
for sample in SAMPLE_FASTQS.keys():
    allvalidPair.append(f"{pairs_library_folder}/{sample}.allValidPairs")

# Rule order for mapper-specific dependencies
if config["map"]["mapper"] == "chromap":
    ruleorder: map_chunks_chromap > parse_sort_chunks
elif config["map"]["mapper"] == "bowtie2":
    pass
else:
    ruleorder: parse_sort_chunks > map_chunks_chromap

# 4. Target Rule
rule all:
    input:
        # QC & Stats
        multiqc,
        combined_stats,
        assemble_mapstats,
        
        # Core Outputs
        library_coolers,
        library_group_coolers if "library_groups" in config["input"] and len(config["input"]["library_groups"]) > 0 else [],
        library_group_hic if "library_groups" in config["input"] and len(config["input"]["library_groups"]) > 0 and config["bin"].get("make_hic", False) else [],
        library_group_stats if "library_groups" in config["input"] and len(config["input"]["library_groups"]) > 0 else [],
        
        # Conditional Outputs
        library_hic if config["bin"].get("make_hic", False) else [],
        library_scaling_pairs if config.get("scaling_pairs", {}).get("do", True) else [],
        
        # Downstream
        library_mustache_loops,
        library_downstream_stat,
        allvalidPair
